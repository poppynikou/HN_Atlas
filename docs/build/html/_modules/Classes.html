
<!DOCTYPE html>

<html lang="Python">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classes &#8212; HN_atlas 1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">HN_atlas 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Classes</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for Classes</h1><div class="highlight"><pre>
<span></span><span class="c1">## script which includes the classes which does the postprocessing of the groupwise registrations</span>
<span class="c1"># which creates the atlas </span>
<span class="kn">from</span> <span class="nn">natsort</span> <span class="kn">import</span> <span class="n">natsorted</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="o">*</span> 

<div class="viewcode-block" id="Imgs"><a class="viewcode-back" href="../classes.html#Classes.Imgs">[docs]</a><span class="k">class</span> <span class="nc">Imgs</span><span class="p">():</span>



    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">batch</span><span class="p">,</span> <span class="n">no_patients</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise the class</span>

<span class="sd">        :param base_path: path to reg_aladin executable (.exe)</span>
<span class="sd">        :type base_path: str</span>
<span class="sd">        :param batch: path to reference image (.nii.gz/.nii)</span>
<span class="sd">        :type batch: str</span>
<span class="sd">        :param no_patients: path to floating image (.nii.gz/.nii)</span>
<span class="sd">        :type no_patients: str or []</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># define path to the batch </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">+</span> <span class="s1">&#39;/BATCH_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
        <span class="c1"># no of patients to process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_patients</span> <span class="o">=</span> <span class="n">no_patients</span>

    <span class="k">def</span> <span class="nf">set_itteration_no</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">itteration</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Initialise the class</span>

<span class="sd">        :param base_path: path to reg_aladin executable (.exe)</span>
<span class="sd">        :type base_path: str</span>
<span class="sd">        :param batch: path to reference image (.nii.gz/.nii)</span>
<span class="sd">        :type batch: str</span>
<span class="sd">        :param no_patients: path to floating image (.nii.gz/.nii)</span>
<span class="sd">        :type no_patients: str or []</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># iteration number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">itteration</span> <span class="o">=</span> <span class="n">itteration</span>

        <span class="c1"># current  folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_path</span> <span class="o">+</span> <span class="s1">&#39;/Iteration_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itteration</span><span class="p">)</span>  
        <span class="c1"># use previous folder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_path</span> <span class="o">+</span> <span class="s1">&#39;/Iteration_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">itteration</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
    
        <span class="c1"># define transformation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">average_transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/average_transformation.nii.gz&#39;</span>
        <span class="c1"># define inverse transformation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_average_transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/inv_average_transformation.nii.gz&#39;</span>

        <span class="c1"># define path to body masks </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_masks</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CT_mask_&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nii.gz&#39;</span><span class="p">))])</span>
        
    
        <span class="k">if</span> <span class="n">itteration</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1">#define reference img </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/average_CT.nii.gz&#39;</span>
            <span class="c1">#define average image path </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">average_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/average_CT.nii.gz&#39;</span>
            <span class="c1"># transformations </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformation_paths</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;transformation_&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;txt&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;backward&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))])</span>
            <span class="c1">#imgs </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgs_path</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;CT_&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nii.gz&#39;</span><span class="p">))])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#define reference img </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/multichannel_average_CT.nii.gz&#39;</span>
            <span class="c1">#define average image path </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">average_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/multichannel_average_CT.nii.gz&#39;</span>
            <span class="c1"># transformations </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformation_paths</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;transformation_&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nii.gz&#39;</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;backward&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">))])</span>
            <span class="c1">#imgs </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imgs_paths</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prev_iteration_path</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;multichannel_CT_&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;nii.gz&#39;</span><span class="p">))])</span>
    
    <span class="k">def</span> <span class="nf">set_nifti_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niftireg_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_transform</span> <span class="o">=</span> <span class="n">niftireg_path</span> <span class="o">+</span><span class="s1">&#39;/reg_transform.exe&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_average</span> <span class="o">=</span> <span class="n">niftireg_path</span> <span class="o">+</span><span class="s1">&#39;/reg_average.exe&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_aladin</span> <span class="o">=</span> <span class="n">niftireg_path</span> <span class="o">+</span><span class="s1">&#39;/reg_aladin.exe&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_resample</span> <span class="o">=</span> <span class="n">niftireg_path</span> <span class="o">+</span><span class="s1">&#39;/reg_resample.exe&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reg_f3d</span> <span class="o">=</span> <span class="n">niftireg_path</span> <span class="o">+</span><span class="s1">&#39;/reg_f3d.exe&#39;</span></div>


<span class="k">class</span> <span class="nc">Alignments</span><span class="p">(</span><span class="n">Imgs</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">():</span>
        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">AffineAlignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itteration</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">RigOnly</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">itteration</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">RigOnly</span> <span class="o">=</span> <span class="kc">False</span> 

        <span class="n">rigidReg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_aladin</span><span class="p">,</span> <span class="n">ref_img</span><span class="p">,</span> <span class="n">float_img</span><span class="p">,</span> <span class="n">affine_matrix</span><span class="p">,</span> <span class="n">resampled_img</span><span class="p">,</span> <span class="n">RigOnly</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">Generate_Bash_Scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1">#function which generates bash script to send to the cluster </span>
        <span class="k">return</span>
    
<span class="k">class</span> <span class="nc">PostProcessing</span><span class="p">(</span><span class="n">Imgs</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span>
    
    <span class="k">def</span> <span class="nf">get_image_objects</span><span class="p">(</span><span class="n">Img_path</span><span class="p">):</span>
        
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Img_path</span><span class="p">)</span>
        <span class="n">img_obj</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">img_affine</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span>
        <span class="n">img_header</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span>

        <span class="k">return</span> <span class="n">img_obj</span><span class="p">,</span> <span class="n">img_affine</span><span class="p">,</span> <span class="n">img_header</span>

    <span class="k">def</span> <span class="nf">calc_average_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itteration</span> <span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_average_transformation_affine</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_average_transformation_def</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">calc_average_transformation_affine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>
    
        <span class="n">avgAff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_average</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_transformation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_paths</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">calc_average_transformation_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformation_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">del</span> <span class="n">_</span>
        <span class="n">average_shape</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span>
        <span class="n">transformation_storage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_patients</span><span class="p">,</span> <span class="n">average_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">average_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">average_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">no_patients</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c1"># import transformation for that particular patient </span>
            <span class="n">transformation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_paths</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 

            <span class="c1"># imports the data </span>
            <span class="n">transformation_obj</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_objects</span><span class="p">(</span><span class="n">transformation_path</span><span class="p">)</span>
            <span class="n">transformation_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transformation_obj</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
            <span class="n">transformation_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">transformation_obj</span><span class="p">)</span>
    
            <span class="c1">#store</span>
            <span class="n">transformation_storage</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">transformation_obj</span>

        <span class="k">del</span> <span class="n">transformation_path</span>
        <span class="k">del</span> <span class="n">transformation_obj</span>
        <span class="k">del</span> <span class="n">_</span>

        <span class="n">Average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">transformation_storage</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">transformation_storage</span>

        <span class="n">Average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Average</span><span class="p">,</span> <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">average_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">average_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">Average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Average</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># read in the first reference image to use the header</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ref_img_affine</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">_</span>
        
        <span class="c1"># save the transformation </span>
        <span class="n">niftiobject1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">Average</span><span class="p">,</span> <span class="n">ref_img_affine</span><span class="p">)</span>
        <span class="n">niftiobject1</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">niftiobject1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_transformation</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">calc_inv_average_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">itteration</span> <span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">invAff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_transformation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_average_transformation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invDef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_transformation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_average_transformation</span><span class="p">)</span>

        
    <span class="k">def</span> <span class="nf">composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">no_patients</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="c1"># import transformation for that particular patient </span>
            <span class="n">transformation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformation_paths</span><span class="p">[</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">composed_transformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/comp_transformation_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.nii.gz&#39;</span>
            <span class="n">ComposeTransformations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_average_transformation</span><span class="p">,</span> <span class="n">transformation_path</span><span class="p">,</span> <span class="n">composed_transformation</span><span class="p">)</span>

    
    <span class="k">def</span> <span class="nf">resample_imgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_prefix</span><span class="p">,</span> <span class="n">mask_prefix</span><span class="p">):</span>
        
        <span class="n">Transformations</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;comp_transformation_&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="s1">&#39;backward&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)))])</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">no_patients</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">float_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs_path</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="n">Transformations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">resampled_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">img_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.nii.gz&#39;</span>
        
            <span class="n">resampleImg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_resample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span><span class="p">,</span> <span class="n">float_img</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">resampled_img</span><span class="p">)</span>

            <span class="n">float_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_masks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">transformation</span> <span class="o">=</span> <span class="n">Transformations</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">resampled_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mask_prefix</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span><span class="s1">&#39;.nii.gz&#39;</span>
            <span class="n">resampleImg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reg_resample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_img</span><span class="p">,</span> <span class="n">float_img</span><span class="p">,</span> <span class="n">transformation</span><span class="p">,</span> <span class="n">resampled_img</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">calc_average_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">img_prefix</span><span class="p">,</span> <span class="n">mask_prefix</span><span class="p">):</span>

        
        <span class="n">Resampled_imgs</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span>  <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">img_prefix</span><span class="p">)])</span>
        <span class="n">Resampled_masks</span> <span class="o">=</span> <span class="n">natsorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span>  <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_iteration_path</span> <span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">mask_prefix</span><span class="p">)])</span>


        <span class="n">img_obj</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_objects</span><span class="p">(</span><span class="n">Resampled_imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">img_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_obj</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">img_obj</span>
        <span class="k">del</span> <span class="n">_</span>


        <span class="c1"># create an array of nans for storage</span>
        <span class="n">Nan_map</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)))</span>
        <span class="k">del</span> <span class="n">img_shape</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Resampled_imgs</span><span class="p">)):</span>

            <span class="c1"># mask each image of the body</span>
            <span class="c1"># and replace the rest of the image with nans</span>
            <span class="c1"># then average over all patients using reg_average</span>


            <span class="c1"># define img and mask path </span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">Resampled_imgs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">mask_path</span> <span class="o">=</span> <span class="n">Resampled_masks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="c1"># read in the body mask </span>
            <span class="n">mask</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_objects</span><span class="p">(</span><span class="n">mask_path</span><span class="p">)</span>
            <span class="n">mask_obj</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>

            <span class="c1"># imports the data </span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
            <span class="n">img_obj</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">img_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img_obj</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="c1"># replaces all the pCT which isnt body with a nan so its not included in the averaging</span>
            <span class="n">img_obj</span><span class="p">[</span><span class="o">~</span><span class="n">mask_obj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;NaN&#39;</span><span class="p">)</span>

            <span class="c1">#store</span>
            <span class="n">Nan_map</span><span class="p">[:,:,:,</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_obj</span>

        <span class="c1"># calculate the average image, ignoring the nans</span>
        <span class="n">Nan_map</span> <span class="o">=</span> <span class="n">Nan_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">Masked_Average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">Nan_map</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">Average</span> <span class="o">=</span> <span class="n">Masked_Average</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">del</span> <span class="n">Nan_map</span>

        <span class="c1"># save </span>
        <span class="n">img_hdr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span>
        <span class="n">img_affine</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span>
        <span class="n">Avg_Niftiobj</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">Average</span><span class="p">,</span> <span class="n">img_affine</span><span class="p">,</span> <span class="n">img_hdr</span><span class="p">)</span>
        <span class="n">Avg_Niftiobj</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Avg_Niftiobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">average_img</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_multichannel_imgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">HN_atlas 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Classes</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Poppy Nikou.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>